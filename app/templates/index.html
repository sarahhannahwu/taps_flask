<!DOCTYPE html>
<html>
<head>
    <title>CSV Analyzer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; font-size: 20px; margin: 0; background-color: #f4f4f4; }
        .container { border: .5rem darkred solid; border-radius: 1rem; padding: 5rem; max-width: 1200px; margin: 2rem auto; background-color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .upload-section { text-align: center; margin-bottom: 50px; }
        .survey-selector { padding: 0.5rem 1rem; border: 1px solid #333; border-radius: 0.25rem; font-size: 20px; margin-right: 1rem; background-color: white; cursor: pointer; }
        .upload-btn { background-color: darkred; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer; margin-right: 1rem; font-size: 20px; }
        .analyze-btn { background-color: transparent; color: black; padding: 0.5rem 1rem; border: black solid 1px; border-radius: 0.25rem; cursor: pointer; font-size: 20px; }
        .analyze-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .file-name { margin-top: 1rem; }
        .chart-container { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; text-align: center; }
        .chart-container > div { display: flex; justify-content: center; }
        .bar { fill: rgb(111, 157, 196); }
        .bar:hover { fill: darkred; }
        .axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
        .feedback-list { padding-left: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px; list-style-type: none; }
        .feedback-list li { margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dotted #eee; }
        h3.section-header { border-bottom: 2px solid darkred; padding-bottom: 10px; margin-top: 60px; margin-bottom: 30px; color: #333; font-size: 28px; }
        .error { color: red; font-weight: bold; margin-top: 20px; display: none; }
        .loading { font-style: italic; margin-top: 20px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">Toolkit for Assessing Phones in Schools</h1>
        <p style="text-align: left; margin-top: 0.5rem; margin-bottom: 2rem; color: #666;">
            Select the survey type below, upload your CSV, and view the results.
        </p>

        <div class="upload-section">
            <select id="surveyType" class="survey-selector">
                <option value="student">Student Survey</option>
                <option value="parent">Parent Survey</option>
                <option value="teacher">Teacher Survey</option>
                <option value="admin">Admin Survey</option>
            </select>

            <input type="file" id="fileInput" class="file-input" accept=".csv" style="display:none;" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose CSV File</button>
            <button class="analyze-btn" id="analyzeBtn" onclick="uploadFile()" disabled>Analyze File</button>
            <div class="file-name" id="fileName"></div>
        </div>

        <div id="loading" class="loading">Analyzing your file...</div>
        <div id="error" class="error"></div>
        <div id="results" class="results"></div>
        <div id="charts" class="charts"></div>
    </div>

    <script>
        // --- 1. SHARED DEFINITIONS ---
        const AGREEMENT_ORDER = ["Strongly disagree", "Somewhat disagree", "Neither agree nor disagree", "Somewhat agree", "Strongly agree"];
        const FREQUENCY_ORDER = ["Never", "This did not happen to me", "Less than once a week", "About once a week", "About half the time", "Sometimes", "Most days", "Most of the time", "Always"];
        const RESTRICTIVENESS_ORDER = ["The policy should be much more restrictive", "The policy should be a little more restrictive", "The policy is just right", "The policy should be a little less restrictive", "The policy should be much less restrictive", "I prefer not to answer"];
        const YES_NO_ORDER = ["Yes", "No", "I prefer not to answer"];
        const GENDER_ORDER = ["Female", "Male", "Other"];
        const GRADE_ORDER = ["9th grade", "10th grade", "11th grade", "12th grade", "Other"];

        // --- 2. CONFIGURATION OBJECT ---
        const SURVEY_CONFIGS = {
            "student": {
                displayOrder: [
                    "Gender", "Grade", 
                    "Estimate how much time you spend on your phone on a typical school day.",
                    "how long do you spend on your phone", 
                    "Q3. Do you feel you can contact your parent(s) in a timely manner when you need to during the school day? ",
                    "Q12. How satisfied are you with your school’s phone policy?",
                    "Q13. How fairly do teachers and staff enforce your school's phone policy? Give your best guess.",
                    "Q14. What percentage of your classmates are using their phone when they shouldn’t be? Give your best guess.",
                    "Q15. In your opinion, should your school's phone policy be more or less restrictive than it is now?",
                    "In the following set of questions, we will ask about how you view your school experience. - In general, I pay attention in class.",
                    "We are interested in understanding how you feel about your school's phone policy. Please rate your agreement with the following statements about your behavior or feelings since the\npolicy was introduced. “Since the new phone policy was introduced...” - I have felt closer to my friends.",
                    "Q31a. In recent weeks, how often have you experienced the following DURING school hours? [Someone teased you or called you names.]",
                    "My school is a place where... - I often feel lonely."
                ],
                sections: {
                    "Demographics": ["Gender", "Grade", "time do you spend"],
                    "Perceptions of the Policy": ["policy", "satisfied", "enforce", "restrictive"],
                    "Academic Outcomes": ["pay attention in class"],
                    "Social & Emotional Outcomes": ["closer to my friends", "Q31a", "feel lonely"]
                },
                customOrders: {
                    "Gender": GENDER_ORDER,
                    "Grade": GRADE_ORDER,
                    "In the following set of questions, we will ask about how you view your school experience. - In general, I pay attention in class.": AGREEMENT_ORDER,
                    "We are interested in understanding how you feel about your school's phone policy. Please rate your agreement with the following statements about your behavior or feelings since the\npolicy was introduced. “Since the new phone policy was introduced...” - I have felt closer to my friends.": AGREEMENT_ORDER,
                    "My school is a place where... - I often feel lonely.": FREQUENCY_ORDER,
                    "Q31a. In recent weeks, how often have you experienced the following DURING school hours? [Someone teased you or called you names.]": FREQUENCY_ORDER,
                    "Q15. In your opinion, should your school's phone policy be more or less restrictive than it is now?": RESTRICTIVENESS_ORDER,
                    "Q3. Do you feel you can contact your parent(s) in a timely manner when you need to during the school day? ": YES_NO_ORDER
                },
                percentageColumns: [
                    "Q12. How satisfied are you with your school’s phone policy?",
                    "Q13. How fairly do teachers and staff enforce your school's phone policy? Give your best guess.",
                    "Q14. What percentage of your classmates are using their phone when they shouldn’t be? Give your best guess."
                ],
                openEndedColumns: ["Q38. Please share any other thoughts you have about your school's phone policy."]
            },

            "parent": {
                displayOrder: [],
                sections: {
                    "Demographics": ["Parent Age", "Child Grade"],
                    "Policy Views": ["support the policy"]
                },
                customOrders: {},
                percentageColumns: [],
                openEndedColumns: []
            },

            "teacher": {
                displayOrder: [
                    "Q1. Currently, do you allow personal devices in your classroom to be used by students for educational purposes on a daily basis?",
                    "Q2. How important is the integration of technology to your everyday teaching practices?  (e.g., showing a YouTube video as an example, Google Classroom, Kahoot, etc.)",
                    "Q3. Does your school have a phone policy?",
                    "Q4. Under your school’s phone policy, when are students allowed to use their phones at school? Select all that apply.",
                    "Q5. How does your school currently restrict access to phones? Select all that apply.",
                    "Q6. Overall, how satisfied are you with your school's phone policy?",
                    "Q7. How consistently do teachers and staff enforce your school's phone policy? Give your best guess.",
                    "Q8. What percentage of your students are using their phone when they shouldn’t be? Give your best guess.",
                    "Q9. In your opinion, should your school's phone policy be more or less restrictive than it is now?",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Seem interested in school]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Maintain positive and respectful relationships with each other]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Seem to care about grades]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Have good attendance]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Participate in class discussions/activities]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Need external disciplinary policies to behave]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Are respectful to staff]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Persist when tasks are challenging]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Demonstrate appropriate effort for task]",
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Are self-motivated]",
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Have difficulty staying on task]",
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Yell or scream]",
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Are easily distracted]",
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Fail to finish tasks or projects]",
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Act defiant when told to do something]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [I share warm relationships with my students.]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [My students and I always seem to be struggling with each other.]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [Dealing with my students drains my energy.]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [My students' feelings toward me can be unpredictable or can change suddenly.]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [My interactions with my students make me feel effective and confident.]",
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [My students seem to feel secure with me.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Adults who work in this school care about the students.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Teachers care about their students.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Students are friendly with each other.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Students care about each other.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Teachers show respect towards parents.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Teachers listen to the concerns of parents.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Students feel safe.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [The school rules are fair.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [This school makes it clear how students are expected to act.]",
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Students know how they are expected to act.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I am satisfied with my co-workers’ competence.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I am satisfied with the behavior among my students.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I am satisfied with my parent interactions at my school.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I feel supported by my school’s  administration with respect to our phone policy.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I enjoy teaching.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I get frustrated during my time teaching in the classroom.]",
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [Teaching often drains my energy.]",
                    "Q17. Please rate the extent to which you agree with the following statements about your relationships with the administration at your school. [I feel supported by the administration at my school.]",
                    "Q17. Please rate the extent to which you agree with the following statements about your relationships with the administration at your school. [I get along well with the administration at my school.]",
                    "Q17. Please rate the extent to which you agree with the following statements about your relationships with the administration at your school. [I feel connected to the administration at my school.]",
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, I feel comfortable talking with my students' parents.]",
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, my students' parents feel comfortable talking with me.]",
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, I enjoy talking with my students' parents.]",
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, I have confidence in my students' parents.]",
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, parents think I am doing good things for their children.]",
                    "Q21. What grade level(s) do you primarily teach?",
                    "Q22. Area(s) taught: (Mark all that apply)",
                    "Q23. At what academic level do you teach the majority of your classes?",
                    "Q24. How many total years of experience do you have working in education (any role)?\n\nYears:",
                    "Q25. What is your gender?",
                    "Q26. With which racial/ethnic groups do you identify? You can select more than one.",
                    "Q1. Overall, how would you say this new phone policy has changed your school?",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students seem more focused in class.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students seem less distracted.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students have developed better social skills.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students have formed closer bonds with their peers.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students are being left out or excluded more.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students seem more anxious without their phones.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students have talked to more people during lunch or breaks.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Students seem less pressured to check their phones.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [There have been fewer discipline problems at my school.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [There seems to be less social drama between students.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Academic outcomes have improved.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Class disruptions have declined.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Lack of smartphone access in class has impaired teaching.]",
                    "Q2. Please rate your agreement with the following statements about your students’ behavior or feelings since the _____ [school to add] policy was introduced. “Since the new phone policy that was introduced in _______ [school to add] … [Nothing has really changed for students.]"
                ],
                sections: {
                    "Demographics": ["years of experience", "what level", "Area(s) taught", "Q21", "Q22", "Q23", "Q24", "Q25"],
                    "Classroom Observations": ["Q12", "Q14", "Q15"],
                    "Policy Views": ["Q6", "Q7", "Q8", "Q9", "restrictive"],
                    "Job Satisfaction & Stress": ["Q16", "Q17", "Q18", "Q19", "Q20"],
                    "Impact of New Policy": ["Q1. Overall", "Since the new phone policy"]
                },
                customOrders: {
                    "Q9. In your opinion, should your school's phone policy be more or less restrictive than it is now?": RESTRICTIVENESS_ORDER,
                    "Q12. Please rate the extent to which you agree that the following statements apply to a significant number of your students.  A significant number of my students… [Seem interested in school]": AGREEMENT_ORDER,
                    "Q13. Please rate the extent to which the following statements apply to your relationship with your students in general.  [I share warm relationships with my students.]": AGREEMENT_ORDER,
                    "Q14. Please indicate how often these behaviors occur from a significant number of your students. [Have difficulty staying on task]": FREQUENCY_ORDER,
                    "Q15. Please read each statement and mark the response that best shows how much you agree. In this school… [Adults who work in this school care about the students.]": AGREEMENT_ORDER,
                    "Q16. Please indicate how strongly you agree or disagree with the following statements about your experience as a teacher at this school.  [I am satisfied with my co-workers’ competence.]": AGREEMENT_ORDER,
                    "Q17. Please rate the extent to which you agree with the following statements about your relationships with the administration at your school. [I feel supported by the administration at my school.]": AGREEMENT_ORDER,
                    "Q18. The following statements are about your overall experiences with the parents of your students. Please read each item and rate the degree to which you agree or disagree with the statement. [In general, I feel comfortable talking with my students' parents.]": AGREEMENT_ORDER,
                    "Q19. Please rate your level of agreement with the following statements about your stress at school. I feel stressed for…  [not having support from the administrators at my school.]": AGREEMENT_ORDER,
                    "Q20. Please rate how often you experience the following: [I feel emotionally drained from my work.]": FREQUENCY_ORDER,
                    "Q1. Overall, how would you say this new phone policy has changed your school?": ["Significantly for the worse", "Somewhat for the worse", "No change", "Somewhat for the better", "Significantly for the better"]
                },
                percentageColumns: [
                     "Q8. What percentage of your students are using their phone when they shouldn’t be? Give your best guess."
                ],
                openEndedColumns: [
                    "Q10. What challenges have you faced with implementing and/or enforcing the phone policy?",
                    "Q11. Do you have any suggestions for overcoming those barriers?",
                    "Q27. Please share any other major changes at this school within the past school year that might have affected student behavior or school climate (e.g., policy changes, large student turnover, etc.).",
                    "Q28. Please share any other thoughts you have about your school's phone policy.",
                    "Q29. Is there anything else you want to share with us?"
                ]
            },

            "admin": {
                displayOrder: [],
                sections: {
                    "School Culture": ["discipline"],
                    "Policy Logistics": ["enforcement"]
                },
                customOrders: {},
                percentageColumns: [],
                openEndedColumns: []
            }
        };

        // --- 3. HELPER FUNCTIONS ---
        function stripQuestionId(columnName) {
            const regex = /^Q\d+[a-zA-Z]*[\.\s\n]*\s*/;
            const cleanedName = columnName.replace(regex, '');
            return cleanedName.length < columnName.length ? cleanedName.trim() : columnName;
        }

        function getSectionForColumn(column, config) {
            if (!config || !config.sections) return null;
            for (const [sectionTitle, keywords] of Object.entries(config.sections)) {
                if (keywords.some(keyword => column.includes(keyword) || column.startsWith(keyword))) {
                    return sectionTitle;
                }
            }
            return null;
        }

        function normalizeCategoryNames(data) {
            const categoryMap = new Map();
            data.forEach(item => {
                let normalizedCategory = item.category;
                if (item.category === "Neither agree / disagree") normalizedCategory = "Neither agree nor disagree";
                if (categoryMap.has(normalizedCategory)) {
                    categoryMap.set(normalizedCategory, categoryMap.get(normalizedCategory) + item.count);
                } else {
                    categoryMap.set(normalizedCategory, item.count);
                }
            });
            return Array.from(categoryMap, ([category, count]) => ({ category, count }));
        }

        function sortPercentageData(data) {
            const extractNumber = (s) => {
                const match = String(s).match(/(\d+)/);
                return match ? parseInt(match[1]) : -1; 
            };
            return data.sort((a, b) => {
                const numA = extractNumber(a.category);
                const numB = extractNumber(b.category);
                if (numA >= 0 && numB < 0) return -1;
                if (numA < 0 && numB >= 0) return 1;
                if (numA >= 0 && numB >= 0) return numA - numB;
                return a.category.localeCompare(b.category);
            });
        }

        function applyCustomOrder(column, data, config) {
            let customOrder = config.customOrders ? config.customOrders[column] : null;

            // Fallback for repeated questions (like Q12 arrays)
            if (!customOrder && config.customOrders) {
                // If the specific column isn't found, try to find a key that is a substring of the column
                // This helps with the repetitive Q12, Q14, etc.
                const matchingKey = Object.keys(config.customOrders).find(key => column.startsWith(key) || column.includes(key.substring(0, 50)));
                if (matchingKey) {
                    customOrder = config.customOrders[matchingKey];
                }
            }

            if (!customOrder) {
                if (column.toLowerCase().includes("grade")) customOrder = GRADE_ORDER;
                else if (column.toLowerCase().includes("gender")) customOrder = GENDER_ORDER;
            }

            if (customOrder) {
                const orderMap = new Map(customOrder.map((item, index) => [item, index]));
                const sortedData = data.filter(d => orderMap.has(d.category)).sort((a, b) => {
                    return orderMap.get(a.category) - orderMap.get(b.category);
                });
                const unlistedData = data.filter(d => !orderMap.has(d.category));
                return sortedData.concat(unlistedData);
            } 
            
            if (config.percentageColumns && config.percentageColumns.includes(column)) {
                return sortPercentageData(data);
            }
            
            return data;
        }

        // --- 4. MAIN LOGIC ---
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const chartsDiv = document.getElementById('charts'); 
        const surveySelector = document.getElementById('surveyType');

        surveySelector.addEventListener('change', () => {
            fileName.textContent = '';
            fileInput.value = '';
            analyzeBtn.disabled = true;
            resultsDiv.style.display = 'none';
            chartsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
        });

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                fileName.textContent = 'Selected: ' + e.target.files[0].name;
                analyzeBtn.disabled = false;
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                chartsDiv.style.display = 'none';
            }
        });

        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                showError('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            chartsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/upload_csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (error) {
                showError('Failed to upload file: ' + error.message);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayResults(data) {
            resultsDiv.innerHTML = '';
            chartsDiv.innerHTML = '';

            const surveyType = surveySelector.value;
            const currentConfig = SURVEY_CONFIGS[surveyType];

            let html = `<h2>${surveyType.charAt(0).toUpperCase() + surveyType.slice(1)} Data Results</h2>`;
            html += `<div class="stat-item"><strong>Number of Respondents:</strong> ${data.num_rows}</div>`;
            html += `<div class="stat-item"><strong>Number of Variables:</strong> ${data.num_columns}</div>`;
            
            if (data.summary_stats && Object.keys(data.summary_stats).length > 0) {
                html += '<h3>Numerical Summary Statistics</h3>';
                for (const [column, stats] of Object.entries(data.summary_stats)) {
                    const displayColumn = stripQuestionId(column);
                    if (stats.mean !== undefined) { 
                         html += `<div class="stat-item">
                            <strong>${displayColumn}:</strong><br>
                            Mean: ${stats.mean?.toFixed(2) || 'N/A'}, 
                            Min: ${stats.min?.toFixed(2) || 'N/A'}, 
                            Max: ${stats.max?.toFixed(2) || 'N/A'}
                        </div>`;
                    }
                }
            }

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            if (data.responses && Object.keys(data.responses).length > 0) {
                
                let columns = Object.keys(data.responses);

                columns.sort((a, b) => {
                    const indexA = currentConfig.displayOrder.indexOf(a);
                    const indexB = currentConfig.displayOrder.indexOf(b);
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return a.localeCompare(b);
                });

                let currentSection = null;
                let chartsGenerated = false;

                for (const column of columns) {
                    const valueCounts = data.responses[column];
                    let displayColumn = stripQuestionId(column);
                    
                    if (column.toLowerCase().includes("time do you spend")) {
                        displayColumn += " (Units: Hours)";
                    }
                    
                    if (currentConfig.openEndedColumns && currentConfig.openEndedColumns.includes(column)) {
                        const feedbackHtml = `
                            <div class="stat-item">
                                <h3 class="section-header">Open-Ended Feedback</h3>
                                <h4>${displayColumn}</h4>
                                <ul class="feedback-list">
                                    ${Object.keys(valueCounts).map(feedback => `<li>${feedback}</li>`).join('')}
                                </ul>
                            </div>`;
                        resultsDiv.innerHTML += feedbackHtml;
                        continue;
                    }
                    
                    if (column === 'Timestamp' || Object.keys(valueCounts).length <= 1) {
                        continue;
                    }

                    const sectionTitle = getSectionForColumn(column, currentConfig);
                    if (sectionTitle && sectionTitle !== currentSection) {
                        chartsDiv.innerHTML += `<h3 class="section-header">${sectionTitle}</h3>`;
                        currentSection = sectionTitle;
                    }

                    let chartData = Object.entries(valueCounts).map(([key, value]) => ({
                        category: key,
                        count: value
                    }));
                    
                    chartData = normalizeCategoryNames(chartData);
                    chartData = applyCustomOrder(column, chartData, currentConfig);

                    const chartId = `chart-${column.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const isRotated = column.includes("restrictive") || chartData.length > 6 || chartData.some(d => d.category.length > 15);

                    chartsDiv.innerHTML += `
                        <div class="chart-container">
                            <h4>${displayColumn}</h4>
                            <div id="${chartId}"></div>
                        </div>`;

                    renderD3BarChart(`#${chartId}`, chartData, column, isRotated);
                    chartsGenerated = true;
                }
                
                if (chartsGenerated) {
                    chartsDiv.style.display = 'block';
                }
            }
        }

        function showError(message) {
            errorDiv.textContent = 'Error: ' + message;
            errorDiv.style.display = 'block';
        }

        function renderD3BarChart(containerSelector, data, column, isRotated) {
            const margin = {top: 20, right: 30, bottom: isRotated ? 60 : 120, left: isRotated ? 200 : 60},
                  width = 500 - margin.left - margin.right,
                  height = 400 - margin.top - margin.bottom;

            d3.select(containerSelector).selectAll("*").remove();

            const svg = d3.select(containerSelector)
              .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const maxCount = d3.max(data, d => d.count);
            
            if (isRotated) {
                const x = d3.scaleLinear().domain([0, maxCount * 1.1]).range([0, width]);
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));

                const y = d3.scaleBand().range([height, 0]).domain(data.map(d => d.category)).padding(0.1);
                svg.append("g").call(d3.axisLeft(y));

                svg.selectAll(".bar").data(data).join("rect")
                    .attr("class", "bar")
                    .attr("x", x(0))
                    .attr("y", d => y(d.category))
                    .attr("height", y.bandwidth())
                    .attr("width", d => x(d.count));

                svg.selectAll(".text").data(data).enter().append("text")
                  .attr("class","label")
                  .attr("x", d => x(d.count) + 5)
                  .attr("y", d => y(d.category) + y.bandwidth() / 2 + 5)
                  .text(d => d.count);
            } else {
                const x = d3.scaleBand().range([ 0, width ]).domain(data.map(d => d.category)).padding(0.2);
                svg.append("g").attr("transform", `translate(0,${height})`)
                  .call(d3.axisBottom(x))
                  .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

                const y = d3.scaleLinear().domain([0, maxCount * 1.1]).range([ height, 0]);
                svg.append("g").call(d3.axisLeft(y).tickFormat(d3.format("d")));

                svg.selectAll(".bar").data(data).join("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.category))
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(d.count))
                    .attr("height", d => height - y(d.count));
                
                svg.selectAll(".text").data(data).enter().append("text")
                  .attr("class","label")
                  .attr("x", d => x(d.category) + x.bandwidth() / 2)
                  .attr("y", d => y(d.count) - 5)
                  .attr("text-anchor", "middle")
                  .text(d => d.count);
            }
        }
    </script>
</body>
</html>