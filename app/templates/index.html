<!DOCTYPE html>
<html>
<head>
    <title>CSV Analyzer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif; 
            font-size: 20px;
            margin: 0;
            background-color: #f4f4f4;
        }
        .container {
            border: .5rem darkred solid;
            border-radius: 1rem;
            padding: 5rem; 
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .upload-section {
            text-align: center;
            margin-bottom: 50px;
        }
        .upload-btn {
            background-color: darkred;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            margin-right: 1rem;
            font-size: 20px;
        }
        .analyze-btn {
            background-color: transparent;
            color: black;
            padding: 0.5rem 1rem;
            border: black solid 1px;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 20px;
        }
        .analyze-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .file-name {
            margin-top: 1rem;
        }
        a {
            color: #666;
        }
        /* Style for D3 Charts */
        .chart-container {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .chart-container > div {
            display: flex;
            justify-content: center;
        }
        .bar {
            fill: rgb(111, 157, 196);
        }
        .bar:hover {
            fill: darkred;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .feedback-list {
            padding-left: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            list-style-type: none;
        }
        .feedback-list li {
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #eee;
        }
        h3.section-header {
            border-bottom: 2px solid darkred;
            padding-bottom: 10px;
            margin-top: 60px; 
            margin-bottom: 30px;
            color: #333;
            font-size: 28px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">Toolkit for Assessing Phones in Schools</h1>
        <p style="text-align: left; margin-top: 0.5rem; margin-bottom: 2rem; color: #666;">
            This is the data analysis tool for the Toolkit for Assessing Phones in Schools (TAPS), a collaboration between the <strong>Stanford Social Media Lab</strong> and the <strong>NYU Tech and Society Lab</strong>. To use this tool, please download your school's TAPS survey data as a .csv file and then upload it here to view summary statistics and visualizations. Because this tool runs within Docker, the data remains on your local machine and is not stored on any server.
            <br>
            <br>
            Please note that this tool is designed specifically for analyzing data collected using the original TAPS survey. Uploading data from a modified or different survey will result in an error. Contact the research team at <a href="mailto:team@ssml.stanford.edu">team@ssml.stanford.edu</a> for assistance.
        </p>

        <div class="upload-section">
            <input type="file" id="fileInput" class="file-input" accept=".csv" style="display:none;" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose CSV File
            </button>
            <button class="analyze-btn" id="analyzeBtn" onclick="uploadFile()" disabled>
                Analyze File
            </button>
            <div class="file-name" id="fileName"></div>
        </div>

        <div id="loading" class="loading" style="display:none;">
            Analyzing your file...
        </div>

        <div id="error" class="error" style="display:none;"></div>

        <div id="results" class="results"></div>
        <div id="charts" class="charts"></div>
    </div>

    <script>
        // --- COLUMN NAME CLEANUP FUNCTION ---
        function stripQuestionId(columnName) {
            const regex = /^Q\d+[a-zA-Z]*[\.\s\n]*\s*/;
            const cleanedName = columnName.replace(regex, '');
            if (cleanedName.length < columnName.length) {
                return cleanedName.trim();
            }
            return columnName;
        }

        // --- 1. DEFINED DISPLAY ORDER ---
        const DISPLAY_ORDER = [
            // Demographics (Canonical Keys)
            "Gender", 
            "Grade",
            "Estimate how much time you spend on your phone on a typical school day.",
            "how long do you spend on your phone", // Handling user's specific text

            // Policy Mechanics
            "Q3. Do you feel you can contact your parent(s) in a timely manner when you need to during the school day? ",
            "Q12. How satisfied are you with your school’s phone policy?",
            "Q13. How fairly do teachers and staff enforce your school's phone policy? Give your best guess.",
            "Q14. What percentage of your classmates are using their phone when they shouldn’t be? Give your best guess.",
            "Q15. In your opinion, should your school's phone policy be more or less restrictive than it is now?",

            // Academic Impact
            "In the following set of questions, we will ask about how you view your school experience. - In general, I pay attention in class.",

            // Social/Emotional Impact
            "We are interested in understanding how you feel about your school's phone policy. Please rate your agreement with the following statements about your behavior or feelings since the\npolicy was introduced. “Since the new phone policy was introduced...” - I have felt closer to my friends.",
            "Q31a. In recent weeks, how often have you experienced the following DURING school hours? [Someone teased you or called you names.]",
            "My school is a place where... - I often feel lonely."
        ];

        // Helper: treat any variant containing the substring as a grade question
        function isGradeQuestion(column) {
            return typeof column === 'string' && column.toLowerCase().includes("grade");
        }
        // Helper: detect gender question variants
        function isGenderQuestion(column) {
            return typeof column === 'string' && column.toLowerCase().includes("gender");
        }
        // Helper: detect usage question
        function isUsageQuestion(column) {
            return column.toLowerCase().includes("time do you spend");
        }

        // --- NEW: Section Mapping Logic ---
        function getSectionForColumn(column) {
            // Include Usage in Demographics section
            if (isGenderQuestion(column) || isGradeQuestion(column) || isUsageQuestion(column)) {
                return "Demographics";
            }
            
            // Perceptions of the Policy: Q3, Q12, Q13, Q14, Q15
            if (column.startsWith("Q3.") || column.startsWith("Q12.") || column.startsWith("Q13.") || column.startsWith("Q14.") || column.startsWith("Q15.")) {
                return "Perceptions of the Policy";
            }
            
            // Academic Outcomes: Attention in class
            if (column.includes("pay attention in class")) {
                return "Academic Outcomes";
            }
            
            // Social/Emotional Outcomes: Friends, Q31a (Teasing), Loneliness
            if (column.includes("closer to my friends") || column.startsWith("Q31a") || column.includes("feel lonely")) {
                return "Social & Emotional Outcomes";
            }
            
            return null; // Unknown section
        }

        // --- CUSTOM FACTOR ORDER DEFINITIONS ---
        const AGREEMENT_ORDER = [
            "Strongly disagree", "Somewhat disagree", "Neither agree nor disagree", "Somewhat agree", "Strongly agree"
        ];

        const FREQUENCY_ORDER = [
            "Never", "This did not happen to me", "Less than once a week", "About once a week", 
            "About half the time", "Sometimes", "Most days", "Most of the time", "Always"
        ];

        const RESTRICTIVENESS_ORDER = [
            "The policy should be much more restrictive", "The policy should be a little more restrictive", 
            "The policy is just right", "The policy should be a little less restrictive", 
            "The policy should be much less restrictive", "I prefer not to answer"
        ];

        const GENDER_ORDER = [
            "Female", "Male", "Non-binary", "Genderqueer", "Prefer not to say", "Other"
        ];
        
        const GRADE_ORDER = [
            "9th grade", "10th grade", "11th grade", "12th grade", "Other"
        ];

        const RESTRICTIVENESS_QUESTION = "Q15. In your opinion, should your school's phone policy be more or less restrictive than it is now?";
        const CONTACT_PARENT_QUESTION = "Q3. Do you feel you can contact your parent(s) in a timely manner when you need to during the school day? ";
        const LONELINESS_QUESTION = "My school is a place where... - I often feel lonely.";

        const CUSTOM_COLUMN_ORDERS = {
            "Gender": GENDER_ORDER,
            "Grade": GRADE_ORDER,
            "In the following set of questions, we will ask about how you view your school experience. - In general, I pay attention in class.": AGREEMENT_ORDER,
            [LONELINESS_QUESTION]: FREQUENCY_ORDER,
            "We are interested in understanding how you feel about your school's phone policy. Please rate your agreement with the following statements about your behavior or feelings since the\npolicy was introduced. “Since the new phone policy was introduced...” - I have felt closer to my friends.": AGREEMENT_ORDER,
            "Q31a. In recent weeks, how often have you experienced the following DURING school hours? [Someone teased you or called you names.]": FREQUENCY_ORDER,
            [RESTRICTIVENESS_QUESTION]: RESTRICTIVENESS_ORDER,
            [CONTACT_PARENT_QUESTION]: ["Yes", "No", "I prefer not to answer"]
        };
        
        const PERCENTAGE_COLUMNS = [
            "Q12. How satisfied are you with your school’s phone policy?",
            "Q13. How fairly do teachers and staff enforce your school's phone policy? Give your best guess.",
            "Q14. What percentage of your classmates are using their phone when they shouldn’t be? Give your best guess.",
        ];
        
        // --- Custom Sorting Functions ---
        function normalizeCategoryNames(data) {
            const categoryMap = new Map();
            data.forEach(item => {
                let normalizedCategory = item.category;
                if (item.category === "Neither agree / disagree") {
                    normalizedCategory = "Neither agree nor disagree";
                }
                if (categoryMap.has(normalizedCategory)) {
                    categoryMap.set(normalizedCategory, categoryMap.get(normalizedCategory) + item.count);
                } else {
                    categoryMap.set(normalizedCategory, item.count);
                }
            });
            return Array.from(categoryMap, ([category, count]) => ({ category, count }));
        }

        function sortPercentageData(data) {
            const extractNumber = (s) => {
                const match = String(s).match(/(\d+)/);
                return match ? parseInt(match[1]) : -1; 
            };
            return data.sort((a, b) => {
                const numA = extractNumber(a.category);
                const numB = extractNumber(b.category);
                if (numA >= 0 && numB < 0) return -1;
                if (numA < 0 && numB >= 0) return 1;
                if (numA >= 0 && numB >= 0) return numA - numB;
                return a.category.localeCompare(b.category);
            });
        }
        
        function applyCustomOrder(column, data) {
            let customOrder = CUSTOM_COLUMN_ORDERS[column];
            
            // Check dynamic assignments if explicit match failed
            if (!customOrder && isGradeQuestion(column)) {
                customOrder = GRADE_ORDER;
            }
            if (!customOrder && isGenderQuestion(column)) {
                customOrder = GENDER_ORDER;
            }

            if (customOrder) {
                const orderMap = new Map(customOrder.map((item, index) => [item, index]));
                const sortedData = data.filter(d => orderMap.has(d.category)).sort((a, b) => {
                    return orderMap.get(a.category) - orderMap.get(b.category);
                });
                const unlistedData = data.filter(d => !orderMap.has(d.category));
                return sortedData.concat(unlistedData);
            } 
            if (PERCENTAGE_COLUMNS.includes(column)) {
                return sortPercentageData(data);
            }
            return data;
        }

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const chartsDiv = document.getElementById('charts'); 

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                fileName.textContent = 'Selected: ' + e.target.files[0].name;
                analyzeBtn.disabled = false;
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                chartsDiv.style.display = 'none';
            }
        });

        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                showError('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            chartsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/upload_csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (error) {
                showError('Failed to upload file: ' + error.message);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayResults(data) {
            resultsDiv.innerHTML = '';
            chartsDiv.innerHTML = '';

            let html = '<h2>Your School\'s Data</h2>';
            html += `<div class="stat-item"><strong>Number of Respondents:</strong> ${data.num_rows}</div>`;
            html += `<div class="stat-item"><strong>Number of Variables:</strong> ${data.num_columns}</div>`;
            
            if (data.summary_stats && Object.keys(data.summary_stats).length > 0) {
                html += '<h3>Numerical Summary Statistics</h3>';
                for (const [column, stats] of Object.entries(data.summary_stats)) {
                    const displayColumn = stripQuestionId(column);
                    if (stats.mean !== undefined) { 
                         html += `<div class="stat-item">
                            <strong>${displayColumn}:</strong><br>
                            Mean: ${stats.mean?.toFixed(2) || 'N/A'}, 
                            Standard Deviation: ${stats.std?.toFixed(2) || 'N/A'}, 
                            Minimum: ${stats.min?.toFixed(2) || 'N/A'}, 
                            Maximum: ${stats.max?.toFixed(2) || 'N/A'}
                        </div>`;
                    }
                }
            }

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            const OPEN_ENDED_COLUMN = "Q38. Please share any other thoughts you have about your school's phone policy.";
            let chartsGenerated = false;

            if (data.responses && Object.keys(data.responses).length > 0) {
                
                // --- 2. SORTING LOGIC ---
                let columns = Object.keys(data.responses);

                columns.sort((a, b) => {
                    // Normalize keys for sorting logic to ensure strict grouping
                    const keyA = isGradeQuestion(a) ? "Grade" : a;
                    const keyB = isGradeQuestion(b) ? "Grade" : b;
                    
                    const finalKeyA = isGenderQuestion(keyA) ? "Gender" : keyA;
                    const finalKeyB = isGenderQuestion(keyB) ? "Gender" : keyB;

                    const indexA = DISPLAY_ORDER.indexOf(finalKeyA);
                    const indexB = DISPLAY_ORDER.indexOf(finalKeyB);

                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return finalKeyA.localeCompare(finalKeyB);
                });

                let currentSection = null;

                // Iterate through the SORTED columns
                for (const column of columns) {
                    const valueCounts = data.responses[column];
                    let displayColumn = stripQuestionId(column);
                    
                    // Add unit label for phone usage question
                    if (isUsageQuestion(column)) {
                        displayColumn += " (Units: Hours)";
                    }
                    
                    // Handle Open-Ended Feedback separately
                    if (column === OPEN_ENDED_COLUMN) {
                        const feedbackHtml = `
                            <div class="stat-item">
                                <h3 class="section-header">Open-Ended Feedback</h3>
                                <h4>${displayColumn}</h4>
                                <ul class="feedback-list">
                                    ${Object.keys(valueCounts).map(feedback => `<li>${feedback}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        resultsDiv.innerHTML += feedbackHtml;
                        continue;
                    }
                    
                    if (column === 'Timestamp' || Object.keys(valueCounts).length <= 1) {
                        continue;
                    }

                    // --- Header Injection Logic ---
                    const sectionTitle = getSectionForColumn(column);
                    if (sectionTitle && sectionTitle !== currentSection) {
                        chartsDiv.innerHTML += `<h3 class="section-header">${sectionTitle}</h3>`;
                        currentSection = sectionTitle;
                    }

                    let chartData = Object.entries(valueCounts).map(([key, value]) => ({
                        category: key,
                        count: value
                    }));
                    
                    chartData = normalizeCategoryNames(chartData);
                    chartData = applyCustomOrder(column, chartData);

                    const chartId = `chart-${column.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const isRotated = column === RESTRICTIVENESS_QUESTION;

                    chartsDiv.innerHTML += `
                        <div class="chart-container">
                            <h4>${displayColumn}</h4>
                            <div id="${chartId}"></div>
                        </div>`;

                    renderD3BarChart(`#${chartId}`, chartData, column, isRotated);
                    chartsGenerated = true;
                }
                
                if (chartsGenerated) {
                    chartsDiv.style.display = 'block';
                }
            }
        }

        function showError(message) {
            errorDiv.textContent = 'Error: ' + message;
            errorDiv.style.display = 'block';
        }

        function renderD3BarChart(containerSelector, data, column, isRotated) {
            const margin = {top: 20, right: 30, bottom: isRotated ? 60 : 120, left: isRotated ? 200 : 60},
                  width = 500 - margin.left - margin.right,
                  height = 400 - margin.top - margin.bottom;

            d3.select(containerSelector).selectAll("*").remove();

            const svg = d3.select(containerSelector)
              .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const maxCount = d3.max(data, d => d.count);
            
            if (isRotated) {
                const x = d3.scaleLinear()
                  .domain([0, maxCount * 1.1])
                  .range([0, width]);
                
                svg.append("g")
                  .attr("transform", `translate(0,${height})`)
                  .call(d3.axisBottom(x).tickFormat(d3.format("d")));

                const y = d3.scaleBand()
                  .range([height, 0])
                  .domain(data.map(d => d.category))
                  .padding(0.1);
                
                svg.append("g")
                  .call(d3.axisLeft(y));

                svg.selectAll(".bar")
                  .data(data)
                  .join("rect")
                    .attr("class", "bar")
                    .attr("x", x(0))
                    .attr("y", d => y(d.category))
                    .attr("height", y.bandwidth())
                    .attr("width", d => x(d.count));

                svg.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10)
                    .text("Number of students");

                svg.selectAll(".text")        
                  .data(data)
                  .enter()
                  .append("text")
                  .attr("class","label")
                  .attr("x", d => x(d.count) + 5)
                  .attr("y", d => y(d.category) + y.bandwidth() / 2 + 5)
                  .text(d => d.count);
                    
            } else {
                const x = d3.scaleBand()
                  .range([ 0, width ])
                  .domain(data.map(d => d.category))
                  .padding(0.2);
                
                svg.append("g")
                  .attr("transform", `translate(0,${height})`)
                  .call(d3.axisBottom(x))
                  .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end");

                const y = d3.scaleLinear()
                  .domain([0, maxCount * 1.1])
                  .range([ height, 0]);
                
                svg.append("g")
                  .call(d3.axisLeft(y).tickFormat(d3.format("d")));

                svg.append("text")
                    .attr("class", "y label")
                    .attr("text-anchor", "middle")
                    .attr("y", -margin.left + 15)
                    .attr("x", -height / 2)
                    .attr("transform", "rotate(-90)")
                    .text("Number of students");

                svg.selectAll(".bar")
                  .data(data)
                  .join("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.category))
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(d.count))
                    .attr("height", d => height - y(d.count));
                
                svg.selectAll(".text")        
                  .data(data)
                  .enter()
                  .append("text")
                  .attr("class","label")
                  .attr("x", d => x(d.category) + x.bandwidth() / 2)
                  .attr("y", d => y(d.count) - 5)
                  .attr("text-anchor", "middle")
                  .text(d => d.count);
            }
        }
    </script>
</body>
</html>